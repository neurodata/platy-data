
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Density Tests &#8212; Platynereis Data</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" href="_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/custom.css" />
    <link rel="stylesheet" type="text/css" href="_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script src="_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js"></script>
    <script async="async" kind="hypothesis" src="https://hypothes.is/embed.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Group Connection Testing" href="sbm_tests.html" />
    <link rel="prev" title="Generate Upsetplots" href="gen_upsetplots.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="index.html">
      
      
      
      <h1 class="site-logo" id="site-title">Platynereis Data</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="abstract.html">
                    Abstract
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Preliminaries
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="introduction.html">
   Introduction
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="make_fig1.html">
   Replicate Fig 1
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="data_summary_v3.html">
   Data Summary Notebook
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="gen_upsetplots.html">
   Generate Upsetplots
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Density Tests
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="sbm_tests.html">
   Group Connection Testing
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  References
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="references.html">
   References
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Slides
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference external" href="https://docs.neurodata.io/platy-data/example.pdf">
   Example
  </a>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<div class="menu-dropdown menu-dropdown-launch-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Launch interactive content">
      <i class="fas fa-rocket"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://mybinder.org/v2/gh/neurodata/platy-data/main?urlpath=tree/platy-data/density_plots.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Launch on Binder"
>
  

<span class="headerbtn__icon-container">
  
    <img src="_static/images/logo_binder.svg">
  </span>
<span class="headerbtn__text-container">Binder</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-repository-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Source repositories">
      <i class="fab fa-github"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://github.com/neurodata/platy-data"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Source repository"
>
  

<span class="headerbtn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="headerbtn__text-container">repository</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/neurodata/platy-data/issues/new?title=Issue%20on%20page%20%2Fdensity_plots.html&body=Your%20issue%20content%20here."
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Open an issue"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="headerbtn__text-container">open issue</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="_sources/density_plots.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.ipynb</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Density Tests</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <section class="tex2jax_ignore mathjax_ignore" id="density-tests">
<h1>Density Tests<a class="headerlink" href="#density-tests" title="Permalink to this headline">#</a></h1>
<p>In this notebook we will be getting densities of the adjacency matrices representing the neurons in different sections of the larva (hemispheres and segments). We will then test if there is any statistical significance between the densities across hemispheres/segments.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>import os
import logging
import pandas as pd
import numpy as np
import itertools
import networkx as nx
import seaborn as sns
from itertools import chain, combinations
from upsetplot import plot
from pathlib import Path
from matplotlib import pyplot as plt
from networkx import from_numpy_array, from_pandas_adjacency, number_of_nodes, number_of_edges, density
from graspologic.embed import AdjacencySpectralEmbed
from graspologic.layouts import layout_tsne, layout_umap
from graspologic.plot.plot import networkplot
from graspologic.utils import is_fully_connected, largest_connected_component, is_symmetric, symmetrize
from graspologic.inference import erdos_renyi_test
from graspologic.plot import adjplot, matrixplot
from statsmodels.stats.proportion import proportion_confint, multinomial_proportions_confint
from pkg.platy import _get_folder, load_connectome_normal_lcc_annotations, load_connectome_lcc_normal_adj, load_0_adj_labels, load_1_adj_labels, load_2_adj_labels, load_3_adj_labels, load_head_adj_labels, load_pygidium_adj_labels, load_left_adj_labels, load_right_adj_labels
</pre></div>
</div>
</div>
</div>
<p>We will first load all of the adjs of the regions we are interested in: the left and right hemisphere, and for the segments, the head, pygidium, segment 1, segment 2, and segment 3. Keep in mind that these adjs represent the largest connected component of each region.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>left_adj, _ = load_left_adj_labels()
right_adj, _ = load_right_adj_labels()
head_adj, _ = load_head_adj_labels()
pyg_adj, _ = load_pygidium_adj_labels()
#adj_0, _ = load_0_adj_labels()
adj_1, _ = load_1_adj_labels()
adj_2, _ = load_2_adj_labels()
adj_3, _ = load_3_adj_labels()

hemi_adjs = [left_adj, right_adj]
segment_adjs = [head_adj, pyg_adj, adj_1, adj_2, adj_3]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>folder = _get_folder()
folder = Path.joinpath(folder, &quot;density_plots&quot;)
folder
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>PosixPath(&#39;/Users/kareefullah/Desktop/NeuroData/neurodata/platy-data/docs/outputs/density_plots&#39;)
</pre></div>
</div>
</div>
</div>
<p>To keep track of the adjs easier, we separate the hemisphere and segment adjs into two dictionaries</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>#sort adjacency matrices into dicts
df_hemis = {&quot;l&quot;: None, &quot;r&quot;: None}
for i, key in enumerate(df_hemis):
    df_hemis[key] = hemi_adjs[i]

df_segments = {&quot;head&quot;: None, &quot;pygidium&quot;: None, &quot;1&quot;: None, &quot;2&quot;: None, &quot;3&quot;: None}
for i, key in enumerate(df_segments):
    df_segments[key] = segment_adjs[i]
</pre></div>
</div>
</div>
</div>
<p>We convert the adjacency matrices to networkx objects so we can get the density of these graphs</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>nx_hemis = {&quot;l&quot;: None, &quot;r&quot;: None}
for key in df_hemis:
    nx_hemis[key] = from_pandas_adjacency(df_hemis[key], create_using=nx.DiGraph)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>nx_segments = {&quot;head&quot;: None, &quot;pygidium&quot;: None, &quot;1&quot;: None, &quot;2&quot;: None, &quot;3&quot;: None}
for key in df_segments:
    nx_segments[key] = from_pandas_adjacency(df_segments[key], create_using=nx.DiGraph)
</pre></div>
</div>
</div>
</div>
<p>We then get the densities of these networkx graphs</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>dens_hemis = {&quot;l&quot;: None, &quot;r&quot;: None}
for key in nx_hemis:
    dens_hemis[key] = density(nx_hemis[key])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>dens_segments = {&quot;head&quot;: None, &quot;pygidium&quot;: None, &quot;1&quot;: None, &quot;2&quot;: None, &quot;3&quot;: None}
for key in nx_segments:
    dens_segments[key] = density(nx_segments[key])
</pre></div>
</div>
</div>
</div>
<p>We concatenate the dicts so we can get a barplot of all the dictionaries we have</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>all_dicts = dens_hemis | dens_segments
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>labels = list(all_dicts.keys())
densities = list(all_dicts.values())
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>sns.set_style(&quot;white&quot;)
sns.barplot(x=labels, y=densities) 
plt.title(&quot;Densities in different sections of the larva&quot;)
plt.xlabel(&quot;Section&quot;)
plt.ylabel(&quot;Density&quot;)
plt.savefig(folder / &quot;densities_sections&quot;)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/density_plots_17_0.png" src="_images/density_plots_17_0.png" />
</div>
</div>
<p>The following function allows us to display confidence intervals of the barplots of hemispheres and segments</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>def plot_barplot(networks, labels, densities, coverage=0.95):
    fig, ax = plt.subplots(figsize=(6, 6))
    palette = None
    
    #barplot features

    ax.set_title(&quot;Densities in different sections of the larva&quot;)
    if len(networks) == 2:
        ax.set_xlabel(&quot;Side&quot;)
        palette = sns.color_palette(&quot;Set1&quot;)
    else:
        ax.set_xlabel(&quot;Segment&quot;)
        palette = sns.color_palette(&quot;Set2&quot;)
        
    ax.set_ylabel(&quot;Density&quot;)
    ax = sns.barplot(x=labels, y=densities, palette=palette)

    if len(networks) == 2:
        ax.set_xticklabels([&quot;left&quot;, &quot;right&quot;])

    #get possible number of edges, number of edges
    possible_edges = []
    num_edges = []
    for i, network in enumerate(networks.values()):
        #possible edges
        n = np.shape(network)[0]
        n_possible = n * (n-1)
        possible_edges.append(n_possible)

        #number of edges
        num_edges.append(np.count_nonzero(network))

    #upper and lower bound for each network
    bounds = []
    for poss, num in zip(possible_edges, num_edges):
        lower, upper = proportion_confint(num, poss, alpha=1-coverage, method=&quot;beta&quot;)
        bounds.append([lower, upper])

    linewidth = 2    
    #plot confidence intervals
    for x, bound in enumerate(bounds):
        ax.plot([x, x], [bounds[x][0], bounds[x][1]], color=&quot;black&quot;, linewidth=linewidth)
    
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>#bar plot for dens_hemis with confidence intervals
hemi_labels = list(dens_hemis.keys())
hemi_densities = list(dens_hemis.values())

#convert pandas df to numpy
np_hemis = {&quot;l&quot;: None, &quot;r&quot;: None}
for key in df_hemis:
    np_hemis[key] = df_hemis[key].to_numpy()
plot_barplot(np_hemis, hemi_labels, hemi_densities)
plt.savefig(folder / &quot;densities_hemis&quot;)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/density_plots_20_0.png" src="_images/density_plots_20_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>#bar plot for dens_segments with confidence intervals
segment_labels = list(dens_segments.keys())
segment_densities = list(dens_segments.values())

#convert pandas df to numpy
np_segments = {&quot;head&quot;: None, &quot;pygidium&quot;: None, &quot;1&quot;: None, &quot;2&quot;: None, &quot;3&quot;: None}
for key in df_segments:
    np_segments[key] = df_segments[key].to_numpy()
plot_barplot(np_segments, segment_labels, segment_densities)
plt.savefig(folder / &quot;densities_segments&quot;)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/density_plots_21_0.png" src="_images/density_plots_21_0.png" />
</div>
</div>
<p>Let’s now run the test for the left and right hemisphere</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>#print p val of er test of left vs right
stats_hemis, pval_hemis, misc_hemis = erdos_renyi_test(np_hemis[&quot;l&quot;], np_hemis[&quot;r&quot;])
print(pval_hemis)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.3636771840698877
</pre></div>
</div>
</div>
</div>
<p>We see that the pvalue is very small, which means that we reject the null hypothesis that the edge probability for the adj of the left hemisphere is not different from the edge probability of the adj of the right hemisphere</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>#5 by 5 df of pvals of the segments
labels_segments = list(dens_segments.keys())
adj_list = list(np_segments.values())

#make pairwise combination list of all elements in list 
pairwise_labels = list(itertools.combinations(labels_segments, 2))
pairwise_adjs = list(itertools.combinations(adj_list, 2))

#initialize dataframe
names = [&quot;head&quot;, &quot;pygidium&quot;, &quot;1&quot;, &quot;2&quot;, &quot;3&quot;]
zero_data = np.zeros(shape=(len(names), len(names)))
pval_df = pd.DataFrame(zero_data, columns=names, index=names)
misc_df = pd.DataFrame(zero_data, columns=names, index=names)
pval_list = []
for label, adjs in zip(pairwise_labels, pairwise_adjs):
    stat, pval, misc = erdos_renyi_test(adjs[0], adjs[1])
    pval_df.loc[label[0]][label[1]] = pval
    pval_df.loc[label[1]][label[0]] = pval
    misc_df.loc[label[0]][label[1]] = misc
    misc_df.loc[label[1]][label[0]] = misc
pval_df.to_csv(folder / &quot;er_pvals_segments.csv&quot;)
pval_df
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>head</th>
      <th>pygidium</th>
      <th>1</th>
      <th>2</th>
      <th>3</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>head</th>
      <td>0.000000e+00</td>
      <td>5.854456e-66</td>
      <td>1.171033e-27</td>
      <td>1.887655e-31</td>
      <td>1.345810e-32</td>
    </tr>
    <tr>
      <th>pygidium</th>
      <td>5.854456e-66</td>
      <td>0.000000e+00</td>
      <td>1.022672e-31</td>
      <td>6.541884e-39</td>
      <td>3.457583e-31</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1.171033e-27</td>
      <td>1.022672e-31</td>
      <td>0.000000e+00</td>
      <td>5.238621e-02</td>
      <td>7.521865e-01</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1.887655e-31</td>
      <td>6.541884e-39</td>
      <td>5.238621e-02</td>
      <td>0.000000e+00</td>
      <td>1.618403e-02</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1.345810e-32</td>
      <td>3.457583e-31</td>
      <td>7.521865e-01</td>
      <td>1.618403e-02</td>
      <td>0.000000e+00</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>The following functions will allow us to visualize the pvalues in a heatmap, where significant p values will be denoted with an X</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>from matplotlib.transforms import Bbox
def shrink_axis(ax, scale=0.7, shift=0):
    pos = ax.get_position()
    mid = (pos.ymax + pos.ymin) / 2
    height = pos.ymax - pos.ymin
    new_pos = Bbox(
        [
            [pos.xmin, mid - scale * 0.5 * height - shift],
            [pos.xmax, mid + scale * 0.5 * height - shift],
        ]
    )
    ax.set_position(new_pos)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>from seaborn.utils import relative_luminance
def plot_pvals(pval_df, names, multiple_correct=True, ax=None):
    if ax is None:
        width_ratios = [0.5, 3, 10]
        fig, axs = plt.subplots(
            1,
            3,
            figsize=(10, 10),
            gridspec_kw=dict(
                width_ratios=width_ratios,
            ),
        )
        axs[1].remove()
        ax = axs[-1]
        cax = axs[0]
    
    plot_pvalues = np.log10(pval_df)
    plot_pvalues.replace(-np.inf, 0, inplace=True)
    im = sns.heatmap(
        plot_pvalues,
        ax=ax,
        cmap=&quot;RdBu&quot;,
        center=0,
        square=True,
        cbar=False,
        fmt=&quot;s&quot;,
    )
    ax.set(ylabel=&quot;Source group&quot;, xlabel=&quot;Target group&quot;)

    if multiple_correct == True:
        ax.set(title=&quot;Density tests p-values segments (corrected)&quot;)
    else:
        ax.set(title=&quot;Density tests p-values segments (uncorrected)&quot;)

    ax.set(xticks=np.arange(len(names)) + 0.5, xticklabels=names)
    colors = im.get_children()[0].get_facecolors()

    shrink_axis(cax, scale=0.5, shift=0.05)
    fig = ax.get_figure()
    _ = fig.colorbar(
        im.get_children()[0],
        cax=cax,
        fraction=1,
        shrink=1,
        ticklocation=&quot;left&quot;,
    )
    cax.set_title(r&quot;$log_{10}$&quot; + &quot;\ncorrected&quot; &quot;\np-value&quot;, pad=20)

    cax.plot(
        [0, 1], [np.log10(0.05), np.log10(0.05)], zorder=100, color=&quot;black&quot;, linewidth=3
    )

    cax.annotate(
        r&quot;$\alpha$&quot;,
        (0.05, np.log10(0.05)),
        xytext=(-5, 0),
        textcoords=&quot;offset points&quot;,
        va=&quot;center&quot;,
        ha=&quot;right&quot;,
        arrowprops={&quot;arrowstyle&quot;: &quot;-&quot;, &quot;linewidth&quot;: 3, &quot;relpos&quot;: (0, 0.5)},
    )
    
    #make X&#39;s
    pad=0.2
    for idx, color in enumerate(colors):
        i, j = np.unravel_index(idx, (len(names), len(names)))
        if i!=j and np.log(pval_df[names[i]][names[j]]) &lt; np.log(0.05):
            lum = relative_luminance(color)
            text_color = &quot;.15&quot; if lum &gt; 0.408 else &quot;w&quot;
            xs = [j + pad, j + 1 - pad]
            ys = [i + pad, i + 1 - pad]
            ax.plot(xs, ys, color=text_color, linewidth=4)
            xs = [j + 1 - pad, j + pad]
            ys = [i + pad, i + 1 - pad]
            ax.plot(xs, ys, color=text_color, linewidth=4)
    

</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>plot_pvals(pval_df, names, multiple_correct=False)
plt.savefig(folder / &quot;density_heatmap_uncorrected.png&quot;)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/density_plots_29_0.png" src="_images/density_plots_29_0.png" />
</div>
</div>
<p>We can see that the p values are significant across the head and pygidium, but seem mostly insignificant across the segments. Let’s use bonferroni’s correction on the segment p-values to reduce the chances of obtaining false positive results since we are using multiple pairwise tests</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>#bonferroni correction for pvals
from statsmodels.stats.multitest import multipletests
np_pvals = pval_df.to_numpy().flatten()
corrected_pvals = multipletests(np_pvals)[1].reshape((len(names), len(names)))
corrected_pvals_df = pd.DataFrame(corrected_pvals, columns=names, index=names)
corrected_pvals_df.to_csv(folder / &quot;er_corrected_pvals_segments.csv&quot;)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>plot_pvals(corrected_pvals_df, names, multiple_correct=True)
plt.savefig(folder / &quot;density_heatmap_corrected.png&quot;)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/Users/kareefullah/Library/Caches/pypoetry/virtualenvs/platy-data-EVeqgmAk-py3.9/lib/python3.9/site-packages/pandas/core/internals/blocks.py:351: RuntimeWarning: divide by zero encountered in log10
  result = func(self.values, **kwargs)
</pre></div>
</div>
<img alt="_images/density_plots_32_1.png" src="_images/density_plots_32_1.png" />
</div>
</div>
<p>The following methods will allow us to plot the density of the sections that we are interested in, as well as the pvalue after running the <code class="docutils literal notranslate"><span class="pre">erdos_renyi_test</span></code></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>def convert_pvalue_to_asterisks(pvalue):
    if pvalue &lt;= 0.0001:
        return &quot;****&quot;
    elif pvalue &lt;= 0.001:
        return &quot;***&quot;
    elif pvalue &lt;= 0.01:
        return &quot;**&quot;
    elif pvalue &lt;= 0.05:
        return &quot;*&quot;
    return &quot;ns&quot;
    
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>def plot_density_bin(pval, label1, label2, misc, method=&quot;beta&quot;, ax=None, coverage=0.95):
    if ax is None:
        fig, ax = plt.subplots(1, 1, figsize=(4, 6))

    n_possible_first = misc[&quot;possible1&quot;]
    n_possible_second = misc[&quot;possible2&quot;]

    density_first = misc[&quot;probability1&quot;]
    density_second = misc[&quot;probability2&quot;]

    n_edges_first = misc[&quot;observed1&quot;]
    n_edges_second = misc[&quot;observed2&quot;]

    first_lower, first_upper = proportion_confint(
        n_edges_first, n_possible_first, alpha=1 - coverage, method=method
    )
    second_lower, second_upper = proportion_confint(
        n_edges_second, n_possible_second, alpha=1 - coverage, method=method
    )
    

    halfwidth = 0.1
    linewidth = 4
    colors = sns.color_palette(&quot;Set2&quot;)
    palette = dict(zip([label1, label2], [colors[0], colors[1]]))

    color = palette[label1]
    x = 0
    ax.plot(
        [x - halfwidth, x + halfwidth],
        [density_first, density_first],
        color=color,
        linewidth=linewidth,
    )
    ax.plot([x, x], [first_lower, first_upper], color=color, linewidth=linewidth)

    color = palette[label2]
    x = 1
    ax.plot(
        [x - halfwidth, x + halfwidth],
        [density_second, density_second],
        color=color,
        linewidth=linewidth,
    )
    ax.plot([x, x], [second_lower, second_upper], color=color, linewidth=linewidth)

    #yticks = [np.round(density_left, 4), np.round(density_right, 4)]
    yticks = [density_first, density_second]
    ax.set(
        xlabel=&quot;Section&quot;,
        xticks=[0, 1],
        xticklabels=[label1, label2],
        xlim=(-0.5, 1.5),
        yticks=yticks,
        # ylim=(0, max(right_upper, left_upper) * 1.05),
        ylabel=r&quot;Estimated density ($\hat{p}$)&quot;,
        title=&quot;{} vs {}; pval: {}, method: {}&quot;.format(label1, label2, pval, method)
    )
    scale = 0.04
    line_shift = 0.000005
    max_upper = max(first_upper, second_upper)
    line_start = max_upper + line_shift
    y_shift = max_upper * scale
    ax.plot([label1, label1, label2, label2], [max_upper+line_shift, max_upper+y_shift, max_upper+y_shift, max_upper+line_shift])
    text = convert_pvalue_to_asterisks(pval)
    
    x_text = 0.5
    y_text = max_upper+y_shift
    ax.text(x_text, y_text, text, ha=&#39;center&#39;, va=&#39;bottom&#39;)
    labels = ax.get_xticklabels()
    for label in labels:
        text_string = label.get_text()
        label.set_color(palette[text_string])
    return ax.get_figure(), ax
</pre></div>
</div>
</div>
</div>
<p>We plot the densities for adjs of the left and right hemisphere</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>bin_folder = Path.joinpath(folder, &quot;pairwise binary plots&quot;)
plot_density_bin(pval_hemis, list(np_hemis.keys())[0], list(np_hemis.keys())[1], misc_hemis, method=&quot;beta&quot;)
plt.savefig(bin_folder / &quot;{} vs {}.png&quot;.format(&quot;left&quot;, &quot;right&quot;), bbox_inches=&#39;tight&#39;)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/density_plots_37_0.png" src="_images/density_plots_37_0.png" />
</div>
</div>
<p>To make comparisons for the segments, we will make two lists: one that has every pairwise combination of the segment names and the other of the pairwise combination of the respective adjs</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>keys = list(np_segments.keys())
vals = list(np_segments[key] for key in keys)
keys = list(itertools.combinations(keys, 2))
vals = list(itertools.combinations(vals, 2))
</pre></div>
</div>
</div>
</div>
<p>We plot the densities of all the pairwise combinations of segments</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>for pair_key, pair_val in zip(keys, vals):
    stat, pval, misc = erdos_renyi_test(pair_val[0], pair_val[1])
    plot_density_bin(pval, pair_key[0], pair_key[1], misc)
    plt.savefig(bin_folder / &quot;{} vs {}.png&quot;.format(pair_key[0], pair_key[1]), bbox_inches=&#39;tight&#39;)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/density_plots_41_0.png" src="_images/density_plots_41_0.png" />
<img alt="_images/density_plots_41_1.png" src="_images/density_plots_41_1.png" />
<img alt="_images/density_plots_41_2.png" src="_images/density_plots_41_2.png" />
<img alt="_images/density_plots_41_3.png" src="_images/density_plots_41_3.png" />
<img alt="_images/density_plots_41_4.png" src="_images/density_plots_41_4.png" />
<img alt="_images/density_plots_41_5.png" src="_images/density_plots_41_5.png" />
<img alt="_images/density_plots_41_6.png" src="_images/density_plots_41_6.png" />
<img alt="_images/density_plots_41_7.png" src="_images/density_plots_41_7.png" />
<img alt="_images/density_plots_41_8.png" src="_images/density_plots_41_8.png" />
<img alt="_images/density_plots_41_9.png" src="_images/density_plots_41_9.png" />
</div>
</div>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="gen_upsetplots.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Generate Upsetplots</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="sbm_tests.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Group Connection Testing</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By Kareef Ullah<br/>
  
      &copy; Copyright 2022.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>